<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <title>Collection View</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  <link href="custom.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MEPG31ZC2R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-MEPG31ZC2R');
  </script>

</head>

<!--
Designed and built by Ed Sperr (esperr@uga.edu or ed_sperr@hotmail.com)
-->
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="venn.js"></script>
<script src="vennframework.js"></script>
<script src="proportion-graph-framework.js"></script>
<!--<script src="yearframework.js"></script>-->


<div class="container" style="min-width: 35em;">

<div id="topbanner" class="jumbotron">
  <h1>Collection View</h1>
  <h2>Library of Congress</h2>
  <a id="about" class="badge badge-pill badge-light" href="about.html">About Collection View</a>
</div>

<div class="row">


<div id="left" class="col-sm-12 col-md-6 col-lg-8">

<div id="search" class="input-group mb-3 col-lg-9 col-md-12 col-sm-12">
  <input type="text" id="pmsearch" class="form-control">
  <div class="input-group-append">
    <button id="runsearch" class="btn btn-primary" type="button">Search</button>
  </div>
</div>

<div id="breakdown">

</div>

<div id="charts">
    <div id="formatpanel" class="card mb-3">
      <div class="card-header">
        Item formats
      </div>
      <div class="card-body">
        <div id="formatresults"></div>
      </div>
    </div>



    <div id="vennpanel" class="card mb-3">
      <div class="card-header">
        Venn diagram
      </div>
      <div class="card-body">
        <div id="vennresults"></div>
      </div>
    </div>
  </div>


</div>

<div class="col-sm-12 col-md-6 col-lg-4">

  <div id="past" class="card mb-3">
    <div class="card-header">
      Searches
    </div>
    <div id="searches" class="panel-body">
    </div>
  </div>

</div>


</div>

<div id="splash" class="card mb-3">
  <div class="card-body">
    <div class="row">

  <div class="col-lg-7 col-sm-12">
    <div class="card mb-3 splashtitle">
      <div class="card-body">
        <p class="card-text">Collection View helps you explore your library's collections (in this case, the <a href="https://www.loc.gov/">Library of Congress</a>) by graphically <em>summarizing</em> your search results. Enter any valid  <a href="https://www.loc.gov/help/search/">LoC
          web search</a> and you'll see it presented in a few different ways...</p>
      </div>
    </div>
  </div>

  <div class="col-lg-5 col-sm-12">
    <div class="card mb-3 splashpart" >
      <img class="card-img-top" src="viruses.png" alt="Formats for 'viruses'">
      <div class="card-body">
        <p class="card-text">Want to see what types of materials you can find for a given search? The number of items of each format found is represented by a compact visualization.
        In this example, the results for 'viruses.'</p>
      </div>
    </div>
    </div>

<div class="col-lg-4 col-sm-12">
    <div class="card mb-3 splashpart">
      <img class="card-img-top" src="death-and-taxes.png" alt="Venn diagram for 'death AND taxes'">
      <div class="card-body">
        <p class="card-text">Want to see how the parts of a complex search interact? Use <a href="https://ncu.libguides.com/researchprocess/boolean">Boolean logic</a>, and youâ€™ll get a Venn diagram in return.
          For example, here are the results for 'death AND taxes.'</p>
      </div>
    </div>
  </div>

<div class="col-lg-4 col-sm-12">
    <div class="card mb-3 splashpart">
      <img class="card-img-top" src="war-formats-proportions.png" alt="Diagram comparing proportions for 'war' by format">
      <div class="card-body">
        <p class="card-text">Curious about how the proportion of different items for a search compare to those of the collection as a whole? A bar graph will show you that comparison for each format.
          In this example, those results for 'war.'</p>
      </div>
    </div>
  </div>

  <div class="col-lg-4 col-sm-12">
    <div class="card mb-3 splashpart">
      <img class="card-img-top" src="sputnik-centuries-proportions.png" alt="Diagram comparing proportions for 'war' by format">
      <div class="card-body">
        <p class="card-text">That same technique can be used to compare search result proproportions by century as well.
          In this example, those results for 'sputnik.'</p>
      </div>
    </div>
  </div>


  </div>

  <div class="row">

 <div class="col-lg-7 col-sm-12">
    <div class="card mb-3 splashtitle">
      <div class="card-body">
        <p class="card-text">If you want to explore different search strategies, you can directly <em>compare</em> them to one another in order to zero-in on exactly the terms you want to use.
          For example, here is the comparison between searches for 'popcorn' and 'popped corn.' <em><a href="about.html">(more)</a></em></p>
      </div>
    </div>
  </div>

  <div class="col-lg-5 col-sm-12">
    <div class="card mb-3 splashpart ">
      <img class="card-img-top" src="popcorn-comps-formats.png">
    </div>
  </div>

  <div class="col-lg-4 col-sm-12">
    <div class="card mb-3 splashpart">
      <img class="card-img-top" src="popcorn-comps-venn.png">
    </div>
  </div>

  <div class="col-lg-4 col-sm-12">
    <div class="card mb-3 splashpart">
      <img class="card-img-top" src="popcorn-comps-format-props.png">
    </div>
  </div>

  <div class="col-lg-4 col-sm-12">
    <div class="card mb-3 splashpart">
      <img class="card-img-top" src="popcorn-comps-century-props.png">
    </div>
  </div>
  </div>
</div>
</div>

<div id="waiting" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="load-text">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Please wait...</h4>
      </div>
      <div class="modal-body">
        <img src="loading-bars.svg">
      </div>
    </div>
  </div>
</div>

</div>

<p style='clear: both; margin-bottom: 60px;'></p>
<br />

<footer class="footer">
  <div class="container">
    <span class="text-muted">Design and contruction by <a href="https://esperr.github.io/about/">Ed Sperr, M.L.I.S.</a>  |
      Data from <a href="https://www.loc.gov/apis/">Library of Congress</a>  |   Visualization tools from  <a href="https://developers.google.com/chart/interactive/docs/gallery/barchart" target="_blank">Google</a> and
      <a href="https://github.com/benfred/venn.js/" target="_blank">Ben Frederickson</a>
     | See the code at <a href="https://github.com/esperr/collection-view">GitHub</a></span>
  </div>
</footer>


<script>
var searches = {};
var pausetime = performance.now();
var searchkey = 0;
var LOCstem = "https://www.loc.gov/search/?q=";
//var centurybaselines = [];
//var formatbaselines = [];


var formatwidth = $("#formatresults").innerWidth() * .9;
var yearwidth = $("#yearresults").innerWidth() * .9;
var vennwidth = $("#vennresults").innerWidth() * .9;
$("#charts").hide();
$("#past").hide();

$( "#yearresults" ).attr( "style", "min-width: " + yearwidth + "px;" );
$( "#vennresults" ).attr( "style", "min-width: " + vennwidth + "px;" );

google.charts.load('current', {packages: ['corechart', 'bar']});


(function() {


function handlesearch() {
  var term = $("#pmsearch").val();
  if (!term) {
    return;
  }
  dosearch(term);
  }

//Page actions and behaviors
function showWait() {
  $( "#pmsearch" ).prop( "disabled", true );
  $( "#pmsearch").val("");
  $( "#runsearch" ).prop( "disabled", true );
  $('#waiting').modal('show');
  }

function showDone() {
  $( "#pmsearch" ).prop( "disabled", false );
  $( "#runsearch" ).prop( "disabled", false );
  $( "#runsearch" ).removeClass( "hideme" );
  $('#waiting').modal('hide');
  setTimeout(function() {
    var isShown = $('#waiting').hasClass('show');
    if (isShown) {
      $('#waiting').modal('hide');
    }
    }, 1000);
  }

$( "#past" ).on( "click", ".pastsearch", function() {
  //while (sets.length) { sets.pop(); }
  var searchIndex = $(this).data("searchIndex");
  showCurrentSearch(searchIndex);
  showMultiFormats([searchIndex]);
  showFormatBaselineComps([searchIndex]);
  if (searches[searchIndex].vennsets.length < 1) {
    $("#vennresults").empty();
    $("#vennresults").append('<p class="vennMsg">Only one valid search term entered<br />To see a Venn diagram, use Boolean opeartors or <em>combine</em> searches using the menu on the right</p>');
  } else {
    sets = searches[searchIndex].vennsets.slice(0);
    drawVennDiagram();
  }
  });


$( "#past" ).on( "click", "#showcompare", function() {
    $("#past input[name='term']").toggle();
    $("#showcompare").toggle();
    $("#savebutton").toggle();
    $("#past dl").after('<input id="compare" type="button" class="btn btn-primary" value="Compare" /><button id="closecompare" type="button" class="btn btn-default showsearches">Close</button>')
    });

$( "#past" ).on( "click", "#compare", function() {
    var comparisons = [];
    $( "input[name='term']" ).each(function( index ) {
      if (this.checked) {
          comparisons.push( $( this ).val() );
        }
      });
      showComparisons(comparisons);
      compVenn(comparisons);
    });

$( "#past" ).on( "click", ".showsearches", function() {
    showSearches();
    });

$( ".row" ).on( "click", "#reset", function() {
    location.replace(location.pathname);
    });

//Searching...
function showSearches() {
  $('#load-session').hide();
  var maxheight = $(".row").first().height() * .8;
  var searchname;
  $( "#searches" ).empty();
  $( "#past" ).removeClass( "hideme" );
  $( "#searches" ).attr( 'style', 'max-height:' + maxheight + 'px' );
  $( "#searches" ).append("<dl>");
  for (var key in searches) {
    if (searches.hasOwnProperty(key)) {
      if (searches[key].nickname) {
        searchname = '"' + searches[key].nickname + '"';
      } else {
        searchname =  searches[key].term;
      }
      $("#searches dl").append('<dt class="pastsearch"><input type="checkbox" name="term" id="' + key + '" value="' + key + '"> <a href="#!">' + searchname + "</a></dt>");
      $("#searches dt").last().append(": " + searches[key].count );
      $("#searches dt").last().data("searchIndex", key);
    }
  }
  $("#past input[name='term']").toggle();
  if ($("#searches dt").last().data("searchIndex") > 0) {
    $("#searches dl").after('<input id="showcompare" type="button" class="btn btn-default" value="Compare searches" />');
  }
 }

//...and displaying results
function showCurrentSearch(searchkey) {
  currentSearch = searches[searchkey];
  $( "#breakdown" ).show();
  $( "#breakdown" ).empty();
  $( "#breakdown" ).append('<p id="yourterm">Your search:</p>');
  $( "#yourterm" ).append("'" + currentSearch.term + "'");
  var lcurl = LOCstem + encodeURI(currentSearch.term);
  $( "#yourterm" ).append('<span id="count"> found <a href="' + lcurl + '" target="_pmresults">' + currentSearch.count + '</a> results</span>');
  $( "#yourterm" ).append('&nbsp; <a href="' + lcurl +'" " target="_blank"><span class="glyphicon glyphicon-link"></span></a>');
  $("#showedit").after(' &nbsp;&nbsp;<button id="deleteme" type="button" class="btn btn-danger">Delete this search</button>');
}

function showMultiFormats(searchkeys) {
  var formatnames = ['Format'];
  var mykey;
  var mysearch;
  var myformats;
  for (m=0; m<searchkeys.length; m++) {
      mysearch = searches[searchkeys[m]];
      var myformats = mysearch.formatcounts;
      for (i=0; i<myformats.length; i++) {
        var formattest = formatnames.filter(obj => {
          return obj.label === myformats[i].format;
        });
        if (formattest.length == 0) {
          var formatObj = {label: myformats[i].format, type: 'number'};
          formatnames.push(formatObj);
        }
      }
  }
  var countsarray = [formatnames];
  for (m=0; m<searchkeys.length; m++) {
      mysearch = searches[searchkeys[m]];
      var formatcounts = [mysearch.term];
      var myformats = mysearch.formatcounts;
      for (i=1; i<formatnames.length; i++) {
        var selectedformat = myformats.filter(obj => {
          return obj.format === formatnames[i].label;
        });
        if (selectedformat.length > 0) {
          formatcounts.push(selectedformat[0].count);
        } else {
          formatcounts.push("0");
        }
      }
      countsarray.push(formatcounts);
  }
  var data = google.visualization.arrayToDataTable(countsarray);

  var options = {
  width: formatwidth,
  height: (formatwidth * 0.3) * searchkeys.length,
  legend: { position: 'top', maxLines: 3 },
  bar: { groupWidth: '60%' },
  isStacked: true
  };
  var chart = new google.visualization.BarChart(document.getElementById('formatresults'));

  //Here comes the clicky bit...
  function selectHandler() {
    var selectedItem = chart.getSelection()[0];
    if (selectedItem && selectedItem.row != null) {
      term = data.getValue(selectedItem.row, 0);
      format = formatnames[selectedItem.column].label;
      var searchroot = getSearchRoot(format);
      var locurl = searchroot + term;
      window.open(locurl,'_formatsearch');
     }
  }
  google.visualization.events.addListener(chart, 'select', selectHandler);
  //google.visualization.events.addListener(chart, 'ready', function () {
  //  showDone();
    //$('#waiting').modal('hide');
  //});
  chart.draw(data, options);
  showDone();
}

function showComparisons(comparisons) {
  $( "#breakdown" ).empty();
  $( "#formatresults" ).empty();
  showMultiFormats(comparisons);
  showFormatBaselineComps(comparisons);
}


 //If something goes wrong, we start over
 function startOver() {
   //$("#loading").remove();
   alert("Something bad happened when we called the API...");
   showDone();
   }

function dosearch(term) {
  if (searchkey == 0) {
    $( "#charts" ).show();
    $( "#past" ).show();
  }

  //showWait();
  $('#waiting').modal('show');
  pausetime = performance.now();

  checkbaselines();

  function checkbaselines() {
    if (baselines.length === proportionfacets.length) {
      callsearch();
    } else {
      setTimeout(checkbaselines, 30);
    }
  }

  function callsearch() {
    $.ajax({
      url: 'https://www.loc.gov/search/',
      error: function () {
        startOver();
        return;
      },
      data: {
      all: 'true',
      q: term,
      fo: 'json'
      },
      success: function( data ) {
        // check to see if we get an unusable response
        if (!data.search) {
          startOver();
          return;
        }
        var totalcount = data.search.hits;
        if (totalcount == "0") {
          $("#breakdown").prepend('<div class="alert alert-danger" role="alert">Nothing found for "' + term + '"! Please try again...</div>');
          showDone();
          //$('#waiting').modal('hide');
          return;
        } else {

        var formatfacets = data.facets.filter(obj => {
          return obj.type === "original-format";
        });
        var formats = formatfacets[0].filters
        var formatcounts = [];
        $.each( formats, function( key, value ) {
          var mycount = value.count;
          var mytitle = value.title;
          //var mymatch = formatbaselines.filter(obj => {
          //  return obj.format === mytitle;
          //});
          var proportion = mycount/totalcount;
          var format = { 'format': mytitle, 'count': mycount, 'proportion': proportion };
          formatcounts.push(format);
        });

        var centuryfacets = data.facets.filter(obj => {
          return obj.type === "dates";
        });
        var centuries = centuryfacets[0].filters
        var centurycounts = [];
        $.each( centuries, function( key, value ) {
          var mycount = value.count;
          var mytitle = value.title;
          var proportion = mycount/totalcount;
          var century = { 'century': mytitle, 'count': mycount, 'proportion': proportion };
          centurycounts.push(century);
        });
        search = {
          'term': term,
          'count': data.search.hits,
          'formatcounts': formatcounts,
          'centurycounts': centurycounts,
        };
        searches[searchkey] = search;

        //showDone();
        showSearches();
        showMultiFormats([searchkey]);
        showFormatBaselineComps([searchkey]);
        //showCenturyBaselineComps([searchkey]);
        //showFormats(searchkey);
        //var facets = data.facets;
        $( ".sharelink" ).remove();
        //yearsearch(searchkey, term);
        startVenn(searchkey, term);
        showCurrentSearch(searchkey);
        searchkey++;
        if (searchkey == 1) {
          $( "#splash" ).hide();
          $("#charts").after('<button id="reset" type="button" style="float: right;" class="btn btn-danger">Reset All Searches</button>');
          $('[data-toggle="popover"]').popover();
        }
        //showTranslation(data.esearchresult.querytranslation);
        }
      }
    });
  }
}

$("#runsearch").click(function(){
    handlesearch();
  });

$(document).keypress(function(e) {
if(e.which == 13) {
    //Because both IE and FF now "helpfully" ignore the spec and treat 'button' the same as 'submit'
    e.preventDefault();
    handlesearch();
  }
});

$( "#savemeLocal" ).click(function() {
  //localStorage.setItem('session', JSON.stringify(searches));
  $('#save-session').modal('hide');
  $('#save-local').modal('show');
});

$( "#savelocally" ).click(function() {
  var savekey = $("input[name='sessionname']").val();
  localStorage.setItem(savekey, JSON.stringify(searches));
  $('#save-local').modal('hide');
});


$( "#loadLocal" ).click(function() {
  var selsession = $('input[name=savedsession]:checked').val();
  searches = JSON.parse(localStorage.getItem(selsession));
  $('#load-local').modal('hide');
  var newIndex = 0;
  for (index in searches) {
    newIndex = index;
  }
  showSearches();
  searchkey = newIndex + 1;
  $( "#vennpanel" ).removeClass( "hideme" );
  $( "#formatpanel" ).removeClass( "hideme" );
});

$( "#deleteLocal" ).click(function() {
  var selsession = $('input[name=savedsession]:checked').val();
  localStorage.removeItem(selsession);
  $('#load-local').modal('hide');
  $('#llocalbutton').remove();
  getLocalsessions();
});

$( "#loadtextfile" ).click(function() {
  var selectedFile = document.getElementById('input').files[0];
  checkdate(selectedFile);
  var r = new FileReader();
  r.onload = function(event) {
  // Why yes, this is a nested mess!
    try {
      (function () {
        searches = JSON.parse(event.target.result);
        var newIndex = 0;
        for (index in searches) {
          newIndex = index;
        }
        showSearches();
        searchkey = newIndex + 1;
      })();
    } catch (e) {
      alert("Unable to load search! Please try again...")
    }
  };
  r.readAsText(selectedFile);
  $( "#vennpanel" ).removeClass( "hideme" );
  $( "#formatpanel" ).removeClass( "hideme" );
  $('#load-text').modal('hide');
});


$( "#save-session" ).on('shown.bs.modal', function (e){
      //alert("I want this to appear after the modal has opened!");
      var dataurl ='data:text/plain;charset=utf-8,'
            + encodeURIComponent(JSON.stringify(searches));
      $("#savemeText").attr("href", dataurl);
      });

function storageAvailable(type) {
    try {
        var storage = window[type],
            x = '__storage_test__';
        storage.setItem(x, x);
        storage.removeItem(x);
        return true;
    }
    catch(e) {
        return e instanceof DOMException && (
            // everything except Firefox
            e.code === 22 ||
            // Firefox
            e.code === 1014 ||
            // test name field too, because code might not be present
            // everything except Firefox
            e.name === 'QuotaExceededError' ||
            // Firefox
            e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
            // acknowledge QuotaExceededError only if there's something already stored
            storage.length !== 0;
    }
}

function getLocalsessions() {
  $("#loadme").empty();
  localSessions = [];
  $.each(localStorage, function(key, value){
     if (typeof localStorage[key] == "string") {
       localSessions.push(key);
      }
    });

  if (localSessions.length > 0) {
    $( "#loadText" ).before('<button id="llocalbutton" class="btn btn-default" title="Tooltip on top" data-toggle="modal" data-target="#load-local">Load local</button>  ');
    //$('[data-toggle="tooltip"]').tooltip();
    for (i=0; i < localSessions.length; i++){
      var myvalue = localSessions[i];
      var myname = localSessions[i];
      $("#loadme").append('<input type="radio" name="savedsession" value="' + myvalue + '"> ' + myname + '<br>');
      }
    $("input[name=savedsession]").prop("checked", true);
  }
}

function checkdate(selectedFile) {
  var now = new Date();
  if ( selectedFile.lastModified ) {
    var filedate = new Date(selectedFile.lastModified);
  } else {
    var filedate = new Date(selectedFile.lastModifiedDate);
  }
  var daysDiff = (Math.floor(now - filedate) / 86400000);
  if (daysDiff > 30) {
    alert("This saved session is more than 30 days old. Result counts may have changed.");
  }
}
})

();
</script>

</body>
</html>
